<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.chaerin.boot4.product.ProductMapper">

	<update id="setUpdate" parameterType="ProductVO">
		UPDATE PRODUCT SET PRODUCTNAME=#{productName}, PRODUCTCOUNT=#{productCount}, PRODUCTPRICE=#{productPrice}
		WHERE PRODUCTNUM=#{productNum}
	
	</update>


	
	<select id="getDetail" parameterType="ProductVO" resultMap="listResult">
		SELECT P.*,PF.*
		FROM 
			PRODUCT P
			LEFT JOIN 
			PRODUCTFILES PF
			USING(PRODUCTNUM)
		WHERE PRODUCTNUM =#{productNum}
	</select>

	<insert id="add" parameterType="ProductVO" useGeneratedKeys="true" keyProperty="productNum">
		INSERT INTO PRODUCT
		VALUES(#{productNum}, #{productName}, #{productPrice}, #{productCount}, #{productDetail}, #{id},#{sale})	
	</insert>
	
	<insert id="fileAdd" parameterType="ProductFilesVO">
	 	INSERT INTO PRODUCTFILES
	 	VALUES(NULL, #{productNum}, #{fileName}, #{oriName})
	</insert>
	
	<select id="list"  parameterType="Pager" resultMap="listResult">
		SELECT P.*, F.*
		FROM 
		(
			SELECT 
			* 
		 	FROM PRODUCT 
		 	WHERE PRODUCTNUM>0 
		 	
		 	<choose>
		 		<when test="id != null">
		 			and ID=#{id}
		 		</when>
		 		<otherwise>
		 			and SALE=1
		 		</otherwise>
		 	</choose>
		 	
	
		 	and 
			<choose>
				<when test="kind == 'col1'">
					PRODUCTNAME
				</when>
				<otherwise>
					PRODUCTDETAIL
				</otherwise>
			</choose>
			LIKE CONCAT('%',#{search},'%')
			ORDER BY PRODUCTNUM DESC
			LIMIT #{startRow}, #{perPage} 	
		 ) P
		LEFT JOIN 
		PRODUCTFILES F
		USING (PRODUCTNUM)
		
 	</select>
 	
 	<resultMap type="ProductVO" id="listResult">
    	<id column="productNum" property="productNum"/>
    	<result column="productName" property="productName"/>
    	<result column="productPrice" property="productPrice"/>
    	<result column="productCount" property="productCount"/>
    	<result column="productDetail" property="productDetail"/>
    	<result column="id" property="id"/>
    	<result column="sale" property="sale"/>
    	<collection property="productFilesVO" javaType="List" ofType="ProductFilesVO">
    		<id column="fileNum" property="fileNum"/>
    		<result column="fileName" property="fileName"/>
    		<result column="oriName" property="oriName"/>
    	</collection>
    </resultMap>
    
    
    
    
	<select id="totalCount" parameterType="Pager" resultType="Long">
	
		SELECT 
			COUNT(PRODUCTNUM) 
		 	FROM PRODUCT 
		 	WHERE PRODUCTNUM>0
		 		 
		 	<if test="id != null">
		 		and ID=#{id}
		 	</if>
		 	and 
				
		<choose>
				<when test="kind == 'col1'">
					PRODUCTNAME
				</when>
				<otherwise>
					PRODUCTDETAIL
				</otherwise>
			</choose>
			LIKE CONCAT('%',#{search},'%')
	</select>
 
</mapper>